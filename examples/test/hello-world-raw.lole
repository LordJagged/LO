; todo for running from self-hosted compiler:
; - types: (& void), u32
; - function imports
; - memory declaration
; - memory export
; - data definition
; - function export
; - function definition
; - instructions:
;   - store instruction:
;     - load with type metadate
;     - load to store convertor
;   - function call
;   - drop (multidrop?)

(import fn Wasi/fd_write [
    (fd              u32) ; file_descriptor
    (iovs           (& void)) ; The pointer to the iov array
    (iovs_len        u32) ; Amount of Wasi/IOVec
    (nwritten       u32) ; Pointer to store the number of bytes written
] u32 :from wasi_snapshot_preview1 fd_write)

(mem m1 :min 1)
(export mem m1 :as memory)

(data 12 "Hello World!\n")

(export main :as _start)
(fn main [] void (
    {u32 @ 4 ; Wasi/IOVec.base
        = 12} ; ref to "Hello World!\n"

    {u32 @ 8 ; Wasi/IOVec.size
        = 13} ; "Hello World!\n".length

    (drop (Wasi/fd_write
        1 ; file_descriptor
        4 ; The pointer to the iov array
        1 ; Amount of Wasi/IOVecs
        0 ; Pointer to store the number of bytes written
    ))
))
